<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenFi - Link Account</title>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            text-align: center;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 420px;
        }
        .logo {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .app-name {
            color: #667eea;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 24px;
        }
        h1 {
            color: #333;
            font-size: 20px;
            margin-bottom: 12px;
        }
        p {
            color: #666;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .secure-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f0fdf4;
            color: #166534;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .success {
            color: #22c55e;
            font-size: 48px;
        }
        .error {
            color: #ef4444;
        }
        #status {
            min-height: 120px;
        }
        .close-hint {
            color: #999;
            font-size: 12px;
            margin-top: 16px;
        }
        .manual-link {
            display: none;
            margin-top: 16px;
        }
        .manual-link a {
            color: #667eea;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ðŸ“Š</div>
        <div class="app-name">OpenFi</div>
        <div class="secure-badge">ðŸ”’ Secure Connection</div>
        <div id="status">
            <div class="spinner"></div>
            <h1>Connecting your account...</h1>
            <p>Complete the login in the popup window.<br>Your credentials are sent directly to your bank.</p>
        </div>
        <div id="manual-link" class="manual-link">
            <a href="#" id="return-link">Click here to return to OpenFi</a>
        </div>
    </div>

    <script>
        // Get link token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const linkToken = urlParams.get('token');

        if (!linkToken) {
            document.getElementById('status').innerHTML =
                '<div class="error">âœ—</div>' +
                '<h1>Missing Token</h1>' +
                '<p>No link token provided. Please try again from the OpenFi app.</p>';
        } else {
            const handler = Plaid.create({
                token: linkToken,
                onSuccess: function(public_token, metadata) {
                    console.log('Plaid Link success:', public_token, metadata);

                    // Build the app redirect URL
                    const appUrl = 'openfi://plaid-oauth?public_token=' + encodeURIComponent(public_token);

                    document.getElementById('status').innerHTML =
                        '<div class="success">âœ“</div>' +
                        '<h1>Account Connected!</h1>' +
                        '<p>Returning to OpenFi...</p>' +
                        '<p class="close-hint">You can close this tab after returning to the app.</p>';

                    // Show manual link as fallback
                    document.getElementById('return-link').href = appUrl;
                    document.getElementById('manual-link').style.display = 'block';

                    // Auto-redirect to app
                    window.location.href = appUrl;
                },
                onExit: function(err, metadata) {
                    console.log('Plaid Link exited:', err, metadata);
                    if (err) {
                        document.getElementById('status').innerHTML =
                            '<div class="error">âœ—</div>' +
                            '<h1>Connection Failed</h1>' +
                            '<p>' + (err.display_message || err.error_message || 'Please try again.') + '</p>' +
                            '<p class="close-hint">Close this tab and try again in OpenFi.</p>';
                    } else {
                        document.getElementById('status').innerHTML =
                            '<h1>Connection Cancelled</h1>' +
                            '<p>You can close this tab and try again.</p>';
                    }
                },
                onEvent: function(eventName, metadata) {
                    console.log('Plaid event:', eventName, metadata);
                }
            });

            // Auto-open Link
            handler.open();
        }
    </script>
</body>
</html>
